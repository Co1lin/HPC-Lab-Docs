# 课程集群使用说明

课程为同学们提供了实验集群来完成作业，并用于进行最终的测试和评分。你 **可以** 不在集群上完成作业，但 **必须** 保证提交的版本能在课程集群上正常地编译和运行，否则可能导致无法得到任何作业分数。所有的正确性和性能测试，都以课程集群的运行结果为准。

## 知识储备

完成该实验需要一定的 Make、SSH、Shell 和 Linux 的使用知识。同时，我们还推荐使用 Git 进行版本控制。如果你是大三或之后选的课程，那么你应该已经在《软件工程》《编译原理》《程序设计训练》等课程中学到了相应的知识。如果你是大一大二选的课程，可以参考以下的教程进行预习：

* Git: [简明指南](https://rogerdudler.github.io/git-guide/index.zh.html) [Git教程](https://www.liaoxuefeng.com/wiki/896043488029600) [缺失的一课](https://missing-semester-cn.github.io/2020/version-control/) [助教编写的 Git 速查文档](https://circuitcoder.github.io/Orange-ECC/ecc/git/) [Git Cheetsheet](https://education.github.com/git-cheat-sheet-education.pdf)
* Make: 见[网原实验相关文档]([/router/doc/howto/make/](https://lab.cs.tsinghua.edu.cn/router/doc/howto/make/))
* Shell: [缺失的一课](https://missing-semester-cn.github.io/2020/command-line/) [Command Line Cheetsheet](https://threenine.co.uk/download/1846/)
* Linux: [USTC LUG Linux 101 在线讲义](https://101.lug.ustc.edu.cn/)

其中特别推荐 [计算机教育中缺失的一课](https://missing-semester-cn.github.io/)，其中包含了大量有用的内容。

## 集群配置

集群由五台 Dell PowerEdge R730 服务器构成，主机名为 `conv[0-5]`，硬件配置为：

* CPU: 2 $\times$ Intel(R) Xeon(R) CPU E5-2680 v4 @ 2.40GHz (14C28T)
* Memory: 16 $\times$ 16 GB DDR4-2400
* Network: 1000 Mbps Ethernet + 100 Gbps Infiniband EDR
* GPU: 1 $\times$ NVIDIA GeForce GTX 1080 (`conv0`) / 1 $\times$ NVIDIA Tesla P100 (`conv[1-4]`)

所有服务器都安装了 Debian 10 (buster) 操作系统，`conv0` 上共有 14TB 的存储，作为提供给同学的共享 home。

## 访问方式

集群的登录节点 `conv0` 可供 SSH 访问，通过下发的用户名（一般为学号）连接到 `166.111.68.163` 的 `2222` 端口即可，在校内和校外都可用。如果使用终端，命令类似 `ssh -p 22222 2019000000@166.111.68.163`。如果使用客户端，注意不要忘记配置端口和用户名。

!!! warning "注意密码安全"

    你可以使用 `passwd` 命令更改登陆密码。为了保证安全，我们在集群上配置了密码复杂性策略：新密码必须至少 12 位长、不能包含用户名、不能包含连续的重复字符、不能包含连续的序列（如 1234）。

为了简化过程和增强安全性，推荐配置公钥进行 SSH 登录，你可以自行搜索相关的教程。

!!! fail "禁止分享账号"

    禁止以任何形式将自己的账号分享给任何其他同学（无论是否选课）使用，包括且不限于提供密码、私钥等。一经发现，涉及的选课同学所有作业成绩无效。

`conv[1-4]` 为计算节点，不允许直接 SSH 连接，只能使用 SLURM 提交作业的形式在上面运行任务。

为了方便同学完成作业，`conv0` 被允许访问校外网络，而 `conv[1-4]` 不能访问集群以外的主机。

## 文件编辑

学生在集群上的 home 目录形如 `/home/course/hpc/users/2020000000`。你应当 **在且仅在** 此目录下放置作业文件。

!!! warning "注意权限"
    
    默认情况下，所有学生账号属于同一个组（`hpc-lab`），但 home 目录仅允许自己访问（默认权限为 `700`）。**严格禁止** 更改自己 home 目录的权限，以防其他人访问你的 home 目录。如果发现故意的此类行为，视同分享账号处理。

集群上安装了 VIM、Emacs、nano 等文本编辑器，你可以自由选取使用。对于不熟悉终端编辑器的同学，推荐使用 VSCode Remote SSH 的方式进行连接和编辑。当然，也可以在本地编写代码并推送到集群上测试，推荐使用 Git 来进行文件的同步和追踪，或者使用 `rsync` 只进行同步。本文档中不会详细介绍任何编辑工具，请同学们自行查阅学习或者询问助教。

为了防止误操作，集群的 home 使用 ZFS 配置了自动的快照备份。每个用户的 home 都是单独的 ZFS dataset，可以通过访问 `~/.zfs/snapshot/` 下各个文件夹的方式获取快照时间点时存在的的文件，文件夹名称即为快照时间。如果需要，也可以请求助教直接将整个 home 回滚到某个当前存在的快照对应的时间点。注意快照是 **只读的** ，并且在一段时间后会自动删除。请 **自行备份** 重要的文件，对于任何误操作导致的后果，包括且不限于作业丢失无法找回等，助教概不负责。

## 工具链与环境加载

## SLURM 使用

## 资源限制

!!! fail "禁止滥用"

    除了上述已经声明的事项，在使用集群时，以下行为也是 **严格禁止** 的：
    
    * 任何与课程教学内容无关的行为，包括且不限于用作入校连接跳板、下载或存放无关文件；
    * 任何恶意的、违反法律法规的行为，包括且不限于发起网络攻击、运行加密货币挖矿；
    * 任何长时间抢占资源的行为，包括且不限于使用脚本循环提交大量任务、在跳板机上运行大量任务。

由于选课人数较多，为了保证同学们能够公平地分享集群资源，我们设定了一系列的资源限制，包括空间限制与任务运行限制。每个用户的 home 配额为 20GB，超出这一限制后将无法再创建或修改文件。如果有合理的需求，可以联系助教进行扩容。

一般情况下，所有选课同学均可无限制地使用实验集群的资源。但是根据经验，集群在作业 deadline 前的一段时间较为繁忙，通常会出现提交任务需要排队，甚至排队较长时间的现象。为保证该时间段内所有同学均有可用的资源，在每次编程作业提交前一周（以网络学堂上的时间限制为准）内，每位同学的总机时将会被限制为 `112` 核时（即假设集群满占用状态下，140 人每人可以在全机上运行一小时）。

注意，上述限制为软限制。对于超出部分，将直接在期末总评中对超出部分**以每核时 1 分的标准进行扣分**。且对于超出限额的任务，随时可能会**在不被通知的情况下被集群管理员中止**。

TODO: 可以在集群的跳板机上运行 `xxxx` 命令来获取当前自己的核时消耗数。
